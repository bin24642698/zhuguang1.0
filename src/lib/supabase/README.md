# 烛光写作 Supabase 集成

本目录包含烛光写作应用与 Supabase 集成的相关代码。

## 提示词加密功能

提示词加密功能使用 AES 加密算法，将提示词内容在客户端加密后再存储到 Supabase 数据库中。这样可以保证提示词内容的安全性，即使数据库被入侵，攻击者也无法获取到提示词的实际内容。

### 工作原理

1. **加密过程**：
   - 提示词内容在发送到服务器前，在客户端使用 AES 加密
   - 加密密钥基于用户ID和固定的盐值生成
   - 加密后的内容存储在 Supabase 数据库中

2. **解密过程**：
   - 默认情况下，从 Supabase 获取的提示词内容保持加密状态
   - 提示词内容对用户完全不可见，UI中显示"作者未公开提示词"
   - 只有在发送给AI服务时才会解密提示词内容
   - 解密使用与加密相同的密钥

3. **密钥管理**：
   - 密钥基于用户ID和固定的盐值生成
   - 盐值存储在环境变量中
   - 密钥不会存储在数据库中，也不会传输到服务器

### 配置

在 `.env.local` 文件中配置以下环境变量：

```
# 功能开关
NEXT_PUBLIC_USE_SUPABASE_PROMPTS=true

# 加密配置
NEXT_PUBLIC_ENCRYPTION_SALT=your-encryption-salt
```

### 使用方法

1. **启用功能**：
   - 设置 `NEXT_PUBLIC_USE_SUPABASE_PROMPTS=true`
   - 确保用户已登录（使用 Supabase 认证）

2. **添加提示词**：
   - 提示词内容会自动加密
   - 加密后的内容存储在 Supabase 数据库中

3. **查看提示词**：
   - 提示词卡片只显示标题和描述，不显示内容
   - 提示词详情页面显示"作者未公开提示词"，用户无法查看实际内容

4. **使用提示词**：
   - 在 AI 写作等功能中使用提示词时，会自动解密内容
   - 解密仅在发送给AI服务时进行，解密后的内容不会显示给用户

### 安全注意事项

1. 加密密钥基于用户ID和盐值生成，确保盐值的安全性
2. 加密和解密都在客户端进行，密钥不会传输到服务器
3. 提示词内容在传输和存储过程中始终保持加密状态
4. 用户永远无法看到提示词的实际内容，只有AI服务能接收到解密后的内容
5. 即使是提示词的创建者也无法查看已保存的提示词内容

## 相关文件

- `promptService.ts`: Supabase 提示词服务
- `../utils/encryption.ts`: 加密工具模块
- `../promptEncryptionManager.ts`: 提示词加密管理器
- `../../scripts/supabase-prompts-schema.sql`: Supabase 提示词表结构
- `../../scripts/test-encryption.js`: 加密测试脚本
